	subtitle	"HIGY.TTProg.asm"	page;===========================================================================================;;  FileName: HIGY.TTProg.asm;  Date: 9/18/04;  File Version: 2.0;  ;  Author: David M. Flynn;  Company: Highland Pacific Railroad;;============================================================================================; Notes:;;  This file is the route selector for Highlad Greeley;;============================================================================================; Revision History;; 2.0     9/18/04	Start of conversion from 6502;;============================================================================================; Conditionals;;============================================================================================;; Name	(additional stack words required) Description;================================================================================================;;================================================================================================; Put Destination in SCount then CALL here to move TT;; Entry: SCount; Exit:; RAM used:; Calls:;TTDoRotate	MOVF	TTTrkOffset,W	;Add offset	ADDWF	SCount,F	ADDCF	SCount+1,F	MOVFW	TTTrkOffset+1	ADDWF	SCount+1,F	CALL	TTSetDir	;find steps and dir	GOTO	Clock	;move it;;================================================================================================; CALL here to setup TT vars and seek home;TTInit	CLRF	StepVar	BSF	CCWFLAGTTInit_L1	MOVLW	low TTSwitch1	;Course zero switch	MOVWF	CurBlk	MOVLW	high TTSwitch1	MOVWF	CurBlk+1	CALL	InputB	BTFSC	IActive,7	;Switch active?	GOTO	TTInit2	; Yes, move CW until not active.	CALL	PULSE	;move one step CCW	GOTO	TTInit_L1;TTInit2	BCF	CCWFLAGTTInit2_L1	MOVLW	low TTSwitch1	;Course zero switch	MOVWF	CurBlk	MOVLW	high TTSwitch1	MOVWF	CurBlk+1	CALL	InputB	BTFSS	IActive,7	;Switch active?	GOTO	TTInit4	; No	CALL	PULSE	; Yes, move CW	GOTO	TTInit2_L1	;TTInit4	MOVLW	low TTSwitch2	;Fine zero switch	MOVWF	CurBlk	MOVLW	high TTSwitch2	MOVWF	CurBlk+1	CALL	InputB	BTFSC	IActive,7	;Switch active?	GOTO	TTInit5	; YesTTInit4_1	CALL	PULSE	GOTO	TTInit4;TTInit5	BTFSS	PHAFLAG	;Stepper at Phase A.	GOTO	TTInit4_1;	CLRF	SCount	CLRF	SCount+1	CLRF	MASTERC	CLRF	MASTERC+1	RETURN;;================================================================================================;Enter SCount=destination step count;Exit  SCount=number of steps;      CCWFlag=direction;TTSetDir	MOVFW	SCount	;SUBTRACT MASTERC (PRESSENT LOCATION) 	SUBWF	MASTERC,W	; FORM SCount (DESTINATION) 	MOVWF	SCount	; FINDING DISTANCE TO MOVE 	MOVFW	SCount+1	SUBWF	MASTERC+1,W	BTFSC	SCount+1,7	;A NEGATIVE NUMBER MEANS 	GOTO	CCW	; WE MUST ROTATE CCW 			;EVEN IF THE RESULT 	MOVFW	SCount	; IS POSITIVE CCW MAY BE  	SUBLW	0xE0	; THE SHORTER DISTANCE 	MOVFW	SCount+1	; SO COMPARE W/ 12000+BACKLASH 	SUBLW	0x2F	; 12256 	BNC	CW;	MOVF	SCount,W	SUBLW	0xC0	;SUBTRACT 24000 (1 REV) 	MOVWF	SCount	; MAKE IT A POSIVE NUMBER 	MOVF	SCount+1,W	; THEN GO CCW 	SUBLW	0x5D	MOVWF	SCount+1	CALL	MAKEPOS	GOTO	CCW1;CW	BCF	CCWFLAG	;CLEAR THE CCW FLAG 	RETURN;CCW	CALL	MAKEPOS 	SETC	MOVFW	SCount	SUBLW	0xE0	MOVFW	SCount+1	SUBLW	0x2D	;12000-BACKLASH OR 11744 	BNC	CCW1	SETC		;AFTER MAKING THE NEG NUMBER 	MOVFW	SCount	; POS IT MAY BE SHORTER TO 	SUBLW	0xC0	; GO CW 	MOVWF	SCount	MOVFW	SCount+1	SUBLW	0x5D	MOVWF	SCount+1	CALL	MAKEPOS		GOTO	CW;CCW1	BSF	CCWFLAG	;SET THE CCW FLAG 			; AND PUT THE 3479P INTO 			;BACKLASH ELIMINATOR			;256 STEPS 	INCF	SCount+1,F	RETURN;MAKEPOS	MOVLW	0x00	SUBWF	SCount,F	SUBBF	SCount+1,F	RETURN;;================================================================================================; Move SCount steps in CCWFlag dir;Clock	MOVF	SCount,W	IORWF	SCount+1,W	SKPZ	GOTO	Clock2	BTFSS	CCWFLAG	GOTO	Clock1;Clock1	MOVF	MASTERC,W	;BACKLASH ELIMINATOR	MOVWF	SCount	INCF	MASTERC+1,W	MOVWF	SCount+1;	CALL	StepDelay;	CALL	StepDelay;	CALL	StepDelay;	CALL	StepDelay	CALL	TTSetDir	GOTO	Clock	;NOT RECURSIVE;Clock2	CALL	StepIt	DECF	SCount,F	INCF	SCount,W	SKPNZ	DECF	SCount+1,F	GOTO	Clock;;================================================================================================;StepIt	CALL	PULSE	BTFSS	CCWFLAG	GOTO	StepItCW;Decrement MASTERC, -1=d'23999'	DECF	MASTERC,F	INCFSZ	MASTERC,W	RETURN	DECF	MASTERC+1,F	INCFSZ	MASTERC+1,W	RETURN	MOVLW	low d'23999'	MOVWF	MASTERC	MOVLW	high d'23999'	MOVWF	MASTERC+1	RETURN;StepItCW	INCF	MASTERC,F	SKPNZ	INCF	MASTERC+1,F	MOVF	MASTERC+1,W		SUBLW	high d'24000'		SKPZ	RETURN	MOVF	MASTERC,W		SUBLW	low d'24000'	SKPZ	RETURN	CLRF	MASTERC	CLRF	MASTERC+1	RETURN;;================================================================================================;NextHalfStep	MOVF	StepVar,W	ADDLW	0x04	SUBLW	0x20	SKPNZ	MOVLW	0x00	MOVWF	StepVar		BSF	PHAFLAG	MOVWF	YReg	RETURN;PrevHalfStep	MOVF	StepVar,W	SKPNZ	MOVLW	0x20	SUBLW	0x04	MOVWF	StepVar		BSF	PHAFLAG	RETURN;DoOneHalfStep	MOVWF	OActive	MOVF	StepVar,W	MOVWF	YReg	CALL	OutputA	MOVLW	0x80	XORWF	OActive,F	INCF	YReg,F	INCF	YReg,F	GOTO	OutputA;PULSE	MOVLW	low Steps	MOVWF	CurBlk	MOVLW	high Steps	ADDLW	low evDataROM	MOVWF	CurBlk+1	BTFSC	CCWFLAG	GOTO	PULSE1	MOVLW	0x00	CALL	DoOneHalfStep	CALL	NextHalfStep;	CLRW	IORLW	FullStepFlag	SKPNZ	RETURN;;	GOTO	Pulse_2;	MOVLW	0x00	CALL	DoOneHalfStep		GOTO	NextHalfStep;Pulse_2	GOTO	StepDelay;PULSE1	CALL	PrevHalfStep	MOVLW	0x80	CALL	DoOneHalfStep	CLRW	IORLW	FullStepFlag	SKPNZ	RETURN;;	GOTO	Pulse1_2;	CALL	PrevHalfStep	MOVLW	0x80	GOTO	DoOneHalfStep	;;Pulse1_2	GOTO	StepDelay;;StepDelay	CLRF	XReg	;10/LOOP 0.00256 SEC/STEP ;StepDelay1	NOP		; OR 62 SEC/REV ;	DECFSZ	XReg,F;	GOTO	StepDelay1;	RETURN;