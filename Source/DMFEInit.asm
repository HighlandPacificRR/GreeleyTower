	subtitle	"DMFEInit.asm"	page;*******************************************************************************;;    Filename: DMFEInit.asm;    Date:9/5/2004;    File Revision:1.0;;    Author:David M. Flynn;    Company:Oxford V.U.E., Inc.;    Project: TCC ComIO version;; ;**********************************************************************;;    Notes:;; 0x00xx	Output Board (Panel); 0x01xx	Output Board (Panel); 0x02xx	Input Board (Panel);; 0x10xx	Output Board (Relays); 0x11xx	Output Board (Relays); 0x14xx	Input Board (Block detectors);;**********************************************************************; Revision History;;1.0  9/6/2004	first reved Version;;===============================================================================RLoop1	CALL	Output	INCF	OBit,F	BTFSS	OBit,7	;skip if high bit = 1	GOTO	RLoop1	;last bit is 127 0x7F	CLRF	OBit	INCF	OBoard,F	MOVF	OBoard,W	SUBWF	Param7A,W	;End with BD1	SKPZ	GOTO	RLoop1	RETURN;;===============================================================================; Entry: none; Exit: none, Bank0 is selected;; turn off all outputs;0000-007F, 0100-017F, 1000-107F, 1100-117F, 1300-137FSetupDMFEIO	CALL	DMFE_Inft_Init	mBank3	MOVLW	0x00	MOVWF	OBit	MOVWF	OActive	MOVLW	0x00	;Start with BD0	MOVWF	OBoard	MOVLW	0x00	;Start with Slot0	MOVWF	OSlot	MOVLW	0x02	MOVWF	Param7A	;do Boards 0 and 1	CALL	RLoop1	INCF	OSlot,F	;Slot 1	CLRF	OBoard	CALL	RLoop1	;do Boards 0 and 1;	;	CLRF	BLKOCC	CLRF	BLKOCC+1;	BCF	RSIP	CLRF	BtnTemp	MOVLW	0x02	MOVWF	BtnTemp+1	CLRF	SMTemp	CLRF	DETTemp	CLRF	OLOC	CLRF	OML1	CLRF	OML2	CLRF	OML3;;Set Relays to Default state	MOVLW	low SetupRoute	MOVWF	RTTemp	MOVLW	high SetupRoute	MOVWF	RTTemp+1	CLRF	YReg;	LCALL	SetRT0	LCALL	ClearRTBtns;;	LCALL	TTInit	mBank0	RETURN;;=====================================================================================HPRROnTheHalf	mBank3;	MOVF	UDPTimer,F	SKPZ	DECF	UDPTimer,F;	BCF	PCLATH,3	GOTO	HPRROnTheHalf_RTN;;=============================================================================;Do_UDP_DataXmit	mBank3	MOVF	UDPTimer,F	SKPZ	GOTO	UDP_DataXmit	MOVLW	kUDPTime	MOVWF	UDPTimer;	BSF	SMTableLowChngFlag	BSF	BlockCmdChngFlag	BSF	BlockCmdChngFlag2	BSF	SMTableHiChngFlag	if HasBlockDetectors	BSF	BlockDataChngFlag	BSF	BlockDataChngFlag2	endif;UDP_DataXmitUDP_DataSender_RTN	mBank3	BTFSS	SMTableLowChngFlag	GOTO	UDP_DataXmit_1;	BCF	SMTableLowChngFlag	MOVLW	UDP_RxIP_MP	mSendSRAM_UDPData	SMTable,kUDP_DataType_LoSM;UDP_DataXmit_1	BTFSS	SMTableHiChngFlag	GOTO	UDP_DataXmit_2;	BCF	SMTableHiChngFlag	MOVLW	UDP_RxIP_MP	mSendSRAM_UDPData	SMTableHigh,kUDP_DataType_HiSM	;UDP_DataXmit_2	BTFSS	BlockCmdChngFlag	GOTO	UDP_DataXmit_3;	BCF	BlockCmdChngFlag	MOVLW	UDP_RxIP_MP	mSendSRAM_UDPData	BlockCmdTable,kUDP_DataType_BlkCmd;UDP_DataXmit_3	BTFSS	BlockCmdChngFlag2	GOTO	UDP_DataXmit_4;	BCF	BlockCmdChngFlag2	MOVLW	UDP_RxIP_MP	mSendSRAM_UDPData	BlockCmdTable2,kUDP_DataType_BlkCmd2;UDP_DataXmit_4	BTFSS	BlockDataChngFlag	GOTO	UDP_DataXmit_5;	BCF	BlockDataChngFlag	MOVLW	UDP_RxIP_MP	mSendSRAM_UDPData	BlockPwrTable,kUDP_DataType_BkPwr;UDP_DataXmit_5	BTFSS	BlockDataChngFlag2	GOTO	UDP_DataXmit_6;	BCF	BlockDataChngFlag2	MOVLW	UDP_RxIP_MP	mSendSRAM_UDPData	BlockPwrTable2,kUDP_DataType_BkPwr2;UDP_DataXmit_6;	BCF	PCLATH,3	GOTO	Do_UDP_DataXmit_Rtn;;	if UsesSpeaker;===================================================================================================;LongClick	MOVLW	0x02	GOTO	Beep_E2CLICK	MOVLW	0x01	GOTO	Beep_E2;Beep	MOVLW	kBeepTimeBeep_E2	BTFSC	BeepOn	;Beep in progress?	RETURN		; Yes	MOVWF	BeepTimer	BSF	BeepOn	MOVLW	low SPKR	;#<SPKR or / =Low byte	MOVWF	CurBlk	MOVLW	high SPKR	;#>SPKR or mod =Hi byte	MOVWF	CurBlk+1	BSF	OActive,7	GOTO	OutputB	endif;;===================================================================================================; BLOCK DETECTIONDETECT	MOVF	BLKOCC,W	SKPZ	GOTO	DETECT1	MOVLW	d'20'	;number of blocks	MOVWF	BLKOCCDETECT1	CALL	BLKTOPTR	MOVLW	DETWEST	MOVWF	YReg	CALL	InputA	MOVFW	IActive	MOVWF	DETTemp	MOVLW	DETEAST	MOVWF	YReg	CALL	InputA	MOVFW	IActive	IORWF	DETTemp,W	MOVWF	OActive	MOVLW	OCCLED	MOVWF	YReg	DECF	BLKOCC,F	GOTO	OutputA;;===========================================================================================;Convert an BLK number in W to Address in CurBlk; CurBlk:=(W-1)*8+FirstBlksData;BLKTOPTR	MOVWF	CurBlk	DECF	CurBlk,F	;Blk:=Blk-1	CLRF	CurBlk+1;	CLRC	RLF	CurBlk,F	;Blk:=Blk*8	RLF	CurBlk+1,F	RLF	CurBlk,F	RLF	CurBlk+1,F	RLF	CurBlk,F	RLF	CurBlk+1,F;	MOVLW	low FirstBlksData	;Blk:=Blk+FirstBlk	ADDWF	CurBlk,F	ADDCF	CurBlk+1,F	MOVLW	high FirstBlksData	ADDLW	low evDataROM	ADDWF	CurBlk+1,F	RETURN;;===================================================================================================;Set the LEDs of all the SMs used by the active routes;	SetSMLeds	MOVLW	0x01	MOVWF	SMTempSMFBLEDS1	CLRF	SMFound	MOVLW	0x0B	MOVWF	XReg	;11..0 bytes	MOVLW	0x01	MOVWF	YReg	;1..0 bits;	MOVLW	low SMBits	ADDWF	XReg,W	MOVWF	FSR	BankISel	SMBits	CLRC;SMFBLEDS1_L1	RRF	INDF,F	DECF	FSR,F	DECF	XReg,F	BTFSS	XReg,7	GOTO	SMFBLEDS1_L1;	RRF	SMFound,F	MOVLW	0x0B	MOVWF	XReg	ADDLW	low SMBits	MOVWF	FSR	DECF	YReg,F	BTFSS	YReg,7	GOTO	SMFBLEDS1_L1;		MOVFW	SMFound	ANDLW	0xC0	;used in any way?	SKPNZ	GOTO	SMFBLEDS4	; No;SMFBLEDS3	BSF	OActive,7	MOVFW	SMTemp	mCall3To2	SMToPTR	;CurBlk=(Ptr)	MOVLW	RealSMNum	MOVWF	YReg	mCall3To0	GetCurBlkY	MOVWF	XReg	mCall3To0	GetSMTableX	CLRF	IActive	BTFSC	Param78,5	;Feedback bit	BSF	IActive,7;	MOVLW	SMLEDB	MOVWF	YReg	MOVF	IActive,W	BMI	SMFBLEDS3_1	MOVLW	SMLEDA	MOVWF	YRegSMFBLEDS3_1	CALL	OutputA;SMFBLEDS4	INCF	SMTemp,F	MOVF	SMTemp,W	SUBLW	SMCount+1	;There are 48 machines	SKPZ	GOTO	SMFBLEDS1	RETURN;